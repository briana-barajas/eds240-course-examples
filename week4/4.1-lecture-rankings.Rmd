---
title: "Visualizing Rankings"
author: "Briana Barajas"
date: 2024-01-29
output:
  html_document:
    code_folding: hide
---

## Pre-Class Prep

Load libraries

```{r, results='hide'}
library(tidyverse)
```

Import data

```{r, results='hide', message=FALSE, warning=FALSE}
jobs <- read_csv("https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2019/2019-03-05/jobs_gender.csv")
```

### Data Wrangling Review

To save time, the data wrangling steps were completed as part of the pre-class prep. View slide 4-5, from lecture 4.1 for additional background information on the data.

```{r}
jobs_clean <- jobs %>% 
  
  # add columns needed for dumbell plot
  mutate(percent_male = 100 - percent_female, # % females w/in industry already included
         
         # difference in earnings between M/F
         difference_earnings = total_earnings_male - total_earnings_female) %>% 
  
  # rearrange columns ---
  relocate(year, major_category, minor_category, occupation,
           total_workers, workers_male, workers_female,
           percent_male, percent_female,
           total_earnings, total_earnings_male, total_earnings_female, difference_earnings,
           wage_percent_of_male) %>% 
  
  #drop rows with missing earning data ----
drop_na(total_earnings_male, total_earnings_female) %>% 
  
  # change occupation data type to factor ----
mutate(occupation = as.factor(occupation)) %>% 
  
  # ---- addutional wrangling for dumbell plot processing ----
mutate(group_label = case_when(percent_female >= 75 ~ "Occupations that are 75%+ female",
                               percent_female >= 45 & percent_female <= 55 ~ "Occupations that are 45-55% female",
                               percent_male >= 75 ~ "Occupations that are 75%+ male"))

```


Two key types we'll be reviewing in this lecture:

-   bar plots

lollipop plots

## Plot One Group {.tabset}

### Bar

```{r}
jobs_clean %>% 
  # filter to year(s) of interest
  filter(year == 2016) %>% 
  
  # keep top 10 jobs with most `total_earnings`
  slice_max(order_by = total_earnings, n = 10) %>%  
  
  # create bar plot
  ggplot(aes(x = fct_reorder(occupation, total_earnings), 
             y = total_earnings)) +
  geom_col() +
  
  geom_text(aes(label = scales::dollar(total_earnings)), hjust = 1.2,
            color = 'white') +
  
  # accuracy rounds to nearest dollar, want scale to be 50k, 100k, etc.
  # since we used label_currency, a $ will be added in front
  scale_y_continuous(labels = scales::label_currency(accuracy = 1,
                                                     scale = 0.001,
                                                     suffix = "k")) +
  coord_flip()
```

`geom_col` will make the height of the bar will equal earnings for each occupation

### Lollipop

```{r, warning=FALSE, message=FALSE}
jobs_clean %>% 
  filter(year == 2016) %>%  
  
  # keep 10 top earning jobs
  slice_max(order_by = total_earnings, n = 10) %>%  
  
  # plot earnings for different occupations
  ggplot(aes(x = fct_reorder(occupation, total_earnings), 
             y = total_earnings)) +
  
  ggalt::geom_lollipop() +
  
  # add labes for total_earnings 
  geom_text(aes(label = scales::dollar(total_earnings)), hjust = -0.2) +
  
  # expand axis to make room for values
  scale_y_continuous(labels = scales::label_currency(accuracy = 1, 
                                                     scale = 0.001, 
                                                     suffix = "k"),
                     limits = c(0, 250000)) + 
  coord_flip()
```
## {-}

## Plot 2 Groups {.tabset}

Additional data wrangling steps need to be included for these plots. Instead of updating `jobs_clean` the wrangling is done before the plot is made, and the new clean data is piped in.

### Bar

```{r}
# bar plot data cleaning ----
jobs_clean %>%  
  filter(year == 2016) |> 
  slice_max(order_by = total_earnings, n = 10) %>% 
  
  # lengthen df using pivot_longer
  pivot_longer(cols = c(total_earnings_female, total_earnings_male), 
               names_to = "group", 
               values_to = "earnings_by_group") %>% 
  
  # create sex column instead of having separate earning columns
  mutate(sex = str_remove(group, pattern = "total_earnings_")) %>%
  
  # two-group bar plot ----
# create ordered bar plot 
ggplot(aes(x = fct_reorder(occupation, earnings_by_group), 
           y = earnings_by_group, fill = sex)) + 
  geom_col(position = position_dodge()) +
  coord_flip()
```

### Lollipop

```{r}
# lollipop data cleaning ----
jobs_clean |>
  filter(year == 2016) |>
  slice_max(order_by = total_earnings, n = 10) |>
  pivot_longer(cols = c(total_earnings_female, total_earnings_male), 
               names_to = "group", 
               values_to = "earnings_by_group") |>
  mutate(sex = str_remove(group, pattern = "total_earnings_")) |>
  
  # lollipop plotting ----
ggplot(aes(x = fct_reorder(occupation, earnings_by_group), 
           y = earnings_by_group, color = sex)) +
  geom_point(position = position_dodge(width = 0.5)) +
  
  # set x-min/x-max to occupation allows the line go through both points
  geom_linerange(aes(xmin = occupation, xmax = occupation, 
                     
                     # set y-min based on position
                     ymin = 0, ymax = earnings_by_group),
                 
                 # default `position = "stack"`
                 position = position_dodge(width = 0.5)) +
  coord_flip()
```
:::

Additional Considerations:

-   these plot types are best for categorical data
-   the y-axis must start at zero
    -   changing where the axis starts increases chance of misinterpretation

## Dumbell Plot
Useful for showing the difference between two groups. They can be produced using a combination of `geom_segment()` and `geom_point`

__Data cleaning__
```{r}
#....guarantee the same random samples each time we run code.....
set.seed(0)

#.........get 10 random jobs that are 75%+ female (2016).........
f75 <- jobs_clean %>% 
  filter(year == 2016, 
         group_label == "Occupations that are 75%+ female") %>%  
  slice_sample(n = 10) #takes random sample

#..........get 10 random jobs that are 75%+ male (2016)..........
m75 <- jobs_clean %>%  
  filter(year == 2016, 
         group_label == "Occupations that are 75%+ male") %>%  
  slice_sample(n = 10)

#........get 10 random jobs that are 45-55%+ female (2016).......
f50 <- jobs_clean %>%  
  filter(year == 2016, 
         group_label == "Occupations that are 45-55% female") %>%  
  slice_sample(n = 10)

#.......combine dfs & relevel factors (for plotting order).......
subset_jobs <- rbind(f75, m75, f50) %>%  
  mutate(group_label = fct_relevel(group_label, 
                                   "Occupations that are 75%+ female", 
                                   "Occupations that are 45-55% female", 
                                   "Occupations that are 75%+ male")) 
```

__Create dumbell plot__
```{r}
# initialize plot (we'll map our aesthetics locally for each geom, below) ----
ggplot(subset_jobs) +
  
  # create dumbbells ----
  # create points that range b/w male and female earnings
  geom_segment(aes(x = total_earnings_female, 
                   xend = total_earnings_male, 
                   
                   # reorder occupation by avg_salary here
                   y = fct_reorder(occupation, total_earnings), 
                   yend = occupation)) + 
  
  # add points for male earnings
  geom_point(aes(x = total_earnings_male, y = occupation), 
             color = "#CD93D8", size = 2.5) +
  
  # add points for female earnings
  geom_point(aes(x = total_earnings_female, y = occupation), 
             color = "#6A1E99", size = 2.5) +
  
  # facet wrap by group ----
  facet_wrap(~group_label, nrow = 3, scales = "free_y") + # "free_y" plots only the axis labels that exist in each group
  
  # axis breaks & $ labels ----
  scale_x_continuous(labels = scales::label_dollar(scale = 0.001, suffix = "k"),
                     breaks = c(25000, 50000, 75000, 100000, 125000))
```

